name: Deploy Node.js to EC2

on:
  push:
    branches: [ main, staging ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      EC2_HOST: ${{ github.ref == 'refs/heads/main' && secrets.EC2_HOST || secrets.STAGING_EC2_HOST }}
      EC2_DEPLOY_PATH: ${{ github.ref == 'refs/heads/main' && secrets.EC2_DEPLOY_PATH || secrets.STAGING_EC2_DEPLOY_PATH }}
      DEPLOY_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      PM2_APP_NAME: ${{ github.ref == 'refs/heads/main' && secrets.PM2_APP_NAME || secrets.STAGING_PM2_APP_NAME }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'  # Adjust to your Node version

    - name: Install dependencies
      run: yarn install

    - name: Build project
      run: yarn build

    - name: Install production dependencies only
      run: |
        rm -rf node_modules
        yarn ci

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Add SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ env.EC2_HOST }} "echo 'SSH connection successful to ${{ env.DEPLOY_ENV }} environment'"

    - name: Deploy to EC2 via rsync
      run: |
        echo "Deploying to ${{ env.DEPLOY_ENV }} EC2 server..."
        rsync -avz --delete \
          --include='dist/***' \
          --include='node_modules/***' \
          --include='package.json' \
          --include='yarn.lock' \
          --exclude='*' \
          ./ ${{ secrets.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.EC2_DEPLOY_PATH }}
        echo "Files deployed successfully!"

    - name: Restart application
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ env.EC2_HOST }} \
          "cd ${{ env.EC2_DEPLOY_PATH }} && pm2 restart ${{ env.PM2_APP_NAME }}"
        echo "Deployment to ${{ env.DEPLOY_ENV }} completed successfully!"